# Что сделать, чтобы всё заработало

Пошаговый чек-лист для полной настройки системы Wi-Fi мониторинга MYDhub.

---

## Часть 1: Windows PC (сервер)

### 1. Установить MQTT брокер (Mosquitto)

```powershell
# Вариант A: скачать с https://mosquitto.org/download/
# Вариант B: через Chocolatey
choco install mosquitto
```

Настройте `mosquitto.conf` для приёма внешних подключений:
```
listener 1883 0.0.0.0
allow_anonymous true
```

Запустите и проверьте:
```powershell
Start-Service mosquitto
netstat -ano | findstr ":1883"
# Должно быть: TCP  0.0.0.0:1883  LISTENING
```

### 2. Открыть порт 1883 в Firewall

Роутер подключается к MQTT брокеру на вашем PC.

```powershell
# Через скрипт
.\setup_firewall.ps1

# Или вручную (от имени администратора)
New-NetFirewallRule -DisplayName "MQTT Broker" -Direction Inbound -LocalPort 1883 -Protocol TCP -Action Allow
```

### 3. Python и зависимости

```powershell
cd c:\Yernur\MYD\integration\MYDhub
pip install -r requirements.txt
```

Зависимости: `paho-mqtt`, `flask`, `flask-cors`, `requests`

### 4. Запустить сервер (Consumer + API)

```powershell
.\start_server.ps1
# Или напрямую:
python main.py
```

Должно появиться:
```
Запуск сервиса Wi-Fi мониторинга...
Подключено к MQTT брокеру localhost:1883
Подписка на топик: wifi/probes
MQTT Consumer запущен
API запущен на http://0.0.0.0:5000
Сервис Wi-Fi мониторинга запущен
```

---

## Часть 2: Роутер (OpenWrt)

### 1. Установить пакеты

```bash
opkg update
opkg install mosquitto-client tcpdump coreutils-timeout
```

> `coreutils-timeout` опционален -- scanner будет работать и без него, но интервал может быть неравномерным.

### 2. Скопировать файлы на роутер

Замените `192.168.1.100` на IP вашего роутера, выполняйте с ПК:

**Способ 1: через SCP (рекомендуется)**

```powershell
cd c:\Yernur\MYD\integration\MYDhub

# -O = legacy SCP (OpenWrt часто не имеет SFTP)
scp -O scanner.sh root@192.168.1.100:/usr/bin/scanner.sh
scp -O router/scanner.conf.example root@192.168.1.100:/etc/scanner.conf
scp -O router/scanner.init root@192.168.1.100:/etc/init.d/scanner
```

**Способ 2: через SSH (если SCP не работает)**

```powershell
Get-Content scanner.sh -Raw | ssh root@192.168.1.100 "cat > /usr/bin/scanner.sh"
Get-Content router/scanner.conf.example -Raw | ssh root@192.168.1.100 "cat > /etc/scanner.conf"
Get-Content router/scanner.init -Raw | ssh root@192.168.1.100 "cat > /etc/init.d/scanner"
```

**Способ 3: вручную через vi**

```bash
ssh root@192.168.1.100
vi /usr/bin/scanner.sh
# Вставить содержимое scanner.sh, сохранить (:wq)
```

> **CRLF:** Если файлы были с окончаниями строк Windows, исправьте на роутере:
> ```bash
> sed -i 's/\r$//' /usr/bin/scanner.sh /etc/scanner.conf /etc/init.d/scanner
> ```

### 3. Настроить /etc/scanner.conf

```bash
ssh root@192.168.1.100
vi /etc/scanner.conf
```

**Обязательно изменить:**

| Параметр | Значение | Пояснение |
|----------|----------|-----------|
| `MQTT_HOST` | IP вашего Windows PC | Например `192.168.1.101` |
| `CYCLE_TIME` | `600` | Отправка каждые 10 минут |

**Параметры стабильности (рекомендуется проверить):**

| Параметр | По умолчанию | Пояснение |
|----------|-------------|-----------|
| `HOME_CHANNEL` | авто | Рабочий канал Wi-Fi сети (1, 6 или 11) |
| `NETWORK_SETTLE_TIME` | `15` | Секунды ожидания после channel hopping |
| `HOST_WAIT_TIMEOUT` | `120` | Макс. ожидание доступности MQTT хоста |
| `MQTT_RETRIES` | `5` | Количество попыток отправки MQTT |
| `MQTT_RETRY_DELAY` | `3` | Начальная задержка между попытками (экспоненциальная) |
| `BUFFER_MAX` | `10` | Макс. буферизованных сообщений при сбое сети |

> **Совет:** Узнать рабочий канал вашей сети:
> ```bash
> iw dev wlan0 info | grep channel
> ```

### 4. Права и интерфейс

```bash
chmod +x /usr/bin/scanner.sh
chmod +x /etc/init.d/scanner

# Создать monitor-интерфейс (если ещё нет)
iw phy phy0 interface add mon0 type monitor
ifconfig mon0 up
```

### 5. Запустить scanner

```bash
/etc/init.d/scanner enable   # Автозапуск при загрузке
/etc/init.d/scanner start    # Запуск сейчас
```

### 6. Проверить работу

```bash
/etc/init.d/scanner status
logread | grep scanner
logread -f | grep scanner    # Следить за логами в реальном времени
```

---

## Часть 3: Frontend (дашборд)

### 1. Установить зависимости и запустить

```powershell
cd c:\Yernur\MYD\integration\MYDhub\frontend
npm install
npm start
```

Браузер откроет http://localhost:3000

### 2. Если API на другом хосте

Создайте `.env` в папке `frontend`:

```
REACT_APP_API_URL=http://localhost:5000/api
```

### Что отображает дашборд

- **Метрики:** пик за всё время, устройств за период, последний замер
- **График:** уникальные устройства по времени (Recharts)
- **Таблица:** список устройств с MAC, RSSI, vendor, type, brand, randomized
- **Периоды:** 1ч, 6ч, 12ч, 1д, 30д
- **Автообновление:** каждые 10 минут

---

## Проверка всей цепочки

| Шаг | Где | Команда | Ожидание |
|-----|-----|---------|----------|
| 1 | PC | `mosquitto_sub -h localhost -t wifi/probes -v` | Сообщения от роутера каждые 10 мин |
| 2 | PC | `curl http://localhost:5000/api/health` | `{"status":"ok"}` |
| 3 | PC | `curl http://localhost:5000/api/stats/summary` | JSON с `peak_all_time`, `last_snapshot`, `total_unique` |
| 4 | PC | `curl "http://localhost:5000/api/stats/devices_timeseries?timeframe=1h"` | JSON с `points` |
| 5 | Браузер | http://localhost:3000 | Дашборд с графиком и таблицей |

---

## Частые проблемы

### Данные не приходят с роутера
- Проверить `ping <IP_PC>` с роутера
- Проверить firewall на PC (порт 1883)
- Проверить `MQTT_HOST` в `/etc/scanner.conf`
- Проверить `netstat -ano | findstr ":1883"` -- должен быть `0.0.0.0:1883`

### MQTT publish failed / Host unreachable
После channel hopping сеть может не успевать восстановиться:
- Увеличить `NETWORK_SETTLE_TIME` (попробовать 20--30)
- Указать `HOME_CHANNEL` явно
- Увеличить `HOST_WAIT_TIMEOUT` (до 180)
- Проверить буфер: `ls /tmp/scanner_buffer/` -- данные сохранены и будут досланы

### График пустой
- Роутер должен отправить хотя бы один батч с устройствами
- Первые данные появятся через CYCLE_TIME секунд (по умолчанию 10 мин)
- Проверить `logread | grep scanner` на роутере

### Scanner падает на роутере
- Проверить интерфейс: `iw dev | grep mon0`
- Запустить вручную: `/usr/bin/scanner.sh` -- смотреть ошибки

### Подробнее
См. [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
